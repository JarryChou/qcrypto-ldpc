<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.19"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>qCrypto: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">qCrypto
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">A collection of code for a practical entanglement-based quantum key distribution system</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.19 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('usbtimetagdriver.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="contents">
<div class="textblock"><p>This README is located in <code>qcrypto/usbtimetagdriver/</code>.</p>
<p>This directory contains the usb driver for the timestamp card, some installation scripts and testing software for that driver.</p>
<p>directory content</p>
<p>driver/ directory containing the kernel driver and corresponding support files. In particular, the usbtimetagio.h contains the ioctl definitions needed for any application talking to the device.</p>
<p>desginstuff/ contains some random thoughts which came up during the driver design.</p>
<p>testapps/ stuff used to test various firmeware and driver evolution stages</p>
<p>Makefile Script to do what you most likely want to do with these files</p>
<p>Installation:</p>
<p>Before you start to install or compile anything, make sure the directory is located in a reasonably stable place, and that this directory is not very likely to removed to any other place as the driver will be loaded from hotplugging out of this directory structure. Here, this directory should reside in /home/qitlab/programs/.</p>
<p>Then, you have to compile the driver itself. The earlier versions seems to run with kernels from 2.6 up to 4.4, with the latest changes confirmed to runon 4.12 kernels. The compilation is done from themain driver directory by saying </p><pre class="fragment">make
</pre><p>Then, the hotplugging machinery needs to be installed. As of 2018, the udev method seems to be dominant. You install the hotplugging stuff with the command </p><pre class="fragment">make udev
</pre><p>This installs a udev rule file and a device driver loader into the directory /etc/udev/rules.d/ of a unified hotplugging mechanism used in this distribution.</p>
<p>By now, everything should be done. You can check the success of the endeavour by plugging in a device and looking for a newly created device file /dev/ioboards/timestamp0.</p>
<p>Driver idea:</p>
<p>The driver itself looks for a device with the Cypress Vendor ID, and the device ID 0x1234 (This is probably not a very smart choice, but USB.org charges 4kUS/yr for a real number....) The connection to the usb device is via endpoint 0, where a set of control commands are transmitted for various device control commands for RF src choice, treshld adjustment, autotransmit etc. Some service commands lead to data sent back via EP1, but they are not relevant for the card operation.</p>
<p>The bulk of the communication from the timestamp card to the driver takes place via EP2, which is operated as a bulk EP bypassing the microcontroller on the timestamp and talking to the event FIFO directly. The transfer should be limited either by the bandwidth of the USB connection, or at the momentary handshake state engine design to 4.2 Mevents per second of 8 bytes each.</p>
<p>The bulk data gets transferred into a kernel buffer consisting of a reasonably large size, which is memory mapped into the user space to avoid needless copying of data for further processing.</p>
<p>The driver should be able to handle multiple cards, although I never tried. It uses dynamic device minor allocation, and currently is part of the usbdevice family. An attempt to come up with a dynamic major number and not piggyback on the usb device unit lead to hotplugging problems with the udev mechanism I could not sort out.</p>
<p>It communicates with the end user via a single device file, and there mainly using the ioctl() methods for device control, and a buffer mapped into user space using mmap(). Internally, the buffer is a hand-knitted scatter-gather buffer list of free RAM pages, which in a future driver version should be replaced by the OS-generic versions of them. Access from the user side takes place via direct access as a linear array. The size of the buffer is defined in the mmap call. It is filled asynchronously via a DMA unit, using concatenated urb requests of dynamically adjusted size to optimize latency and throughput. It operates both with USB 1.x and USB2.0 host adapters, the only difference is the mean event rate which can be obtained.</p>
<p>The driver should be able to handle multiple cards plugged into the system, and at least udev should distribute meaningful device names dynamically.</p>
<p>Driver API:</p>
<ul>
<li>request a buffer with the mmap command.</li>
<li>various control ioctls for steering the hardware, the DMA engine in the driver, and to find out the amount of transferred data. See <a class="el" href="readevents3_8c.html">readevents3.c</a> application to get an idea how the commands are used.</li>
</ul>
<p>Issues: Not sure if multiple cards will be handled nicely, especially in the 9.3 hotpluging script.</p>
<p>Error scenarios:</p>
<p>The device in /dev/ioboards/timestamp0 does not show up.</p>
<ul>
<li>Test if the system recognizes the device by calling lsusb as superuser and look for a device with Cypress Vendor ID and a Device ID of 1234. If you do not find the device, the driver can not be loaded.</li>
<li>you got the wrong hotplugging script installed. Check your distribution</li>
</ul>
<p>Christian Kurtsiefer, 30.1.07</p>
<p>Updates to this document with kernel 4.12 adaptation: 14.7.2018chk </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.19 </li>
  </ul>
</div>
</body>
</html>
